# Changelog de commit

- Commit: `250de18`
- Fecha: `2026-01-26 10:20`
- Autor: `Ismael Leiva Zurita`

## Resumen

Implementación de servicios críticos que cubren notificaciones (Phase 4), medicamentos, y sincronización offline (Phase 5). Incluye utilities y custom hooks para facilitar uso en componentes.

## Detalles

### Added

#### Services

**NotificationService** (`src/services/NotificationService.ts`)
- `scheduleReminder(medication, minutesBefore)`: Agendar recordatorios locales
- `cancelReminder(medicationId, time?)`: Cancelar recordatorios
- `cancelAllReminders()`: Limpiar todos los recordatorios
- `showLocalNotification(title, message, data)`: Mostrar notificación inmediata
- `setupNotificationHandler()`: Configurar manejador de respuestas
- Persistencia de reminders en AsyncStorage con recuperación en app start

**MedicationService** (`src/services/MedicationService.ts`)
- `createMedication(userId, medication)`: Crear con UUID y caché local
- `getMedications(userId)`: Obtener con fallback offline
- `updateMedication(userId, medicationId, updates)`: Actualizar con sync
- `deleteMedication(userId, medicationId)`: Eliminar con caché
- `recordAdherence(userId, medicationId, taken, takenAt?)`: Registrar tomas
- `getTodaysMedications(userId)`: Filtrar por rango de fechas activas
- `getAdherenceStats(userId, medicationId, days)`: Estadísticas de cumplimiento
- Caché local con `AsyncStorage` para operaciones offline

**SyncService** (`src/services/SyncService.ts`)
- `addToSyncQueue(userId, action, entityType, entityId, data)`: Encolar operación
- `processSyncQueue(userId, onProgress)`: Procesar con reintentos exponenciales
  - 3 reintentos máximo
  - Exponential backoff: 1s, 2s, 4s, etc.
  - Callback de progreso para UI
- `getSyncQueue(userId)`: Obtener items pendientes
- `getSyncQueueSize(userId)`: Obtener cantidad
- `hasPendingSync(userId)`: Verificar si hay pendencias
- `clearSyncQueue(userId)`: Limpiar cola manualmente

**FavoritesService** (`src/services/FavoritesService.ts`)
- `addFavorite(userId, pharmacyId)`: Agregar a favoritos con sync
- `removeFavorite(userId, pharmacyId)`: Eliminar de favoritos
- `getFavorites(userId)`: Obtener lista con caché
- `isFavorite(userId, pharmacyId)`: Verificar estado
- Sincronización bidireccional Firestore <-> AsyncStorage

#### Custom Hooks

**usePharmacies()** (`src/hooks/usePharmacies.ts`)
- Interfaz unificada para operaciones de farmacias
- `fetchPharmacies()`: Cargar lista
- `fetchOnDutyPharmacies()`: Cargar turnos
- `getPharmaciesNearby(location, radiusKm)`: Buscar cercanas
- `searchPharmacies(query)`: Búsqueda fuzzy
- `getPharmacy(id)`: Obtener detalles
- Enriquecimiento automático con estado de turno
- Manejo de errores con fallback a caché

**useSyncQueue()** (`src/hooks/useSyncQueue.ts`)
- `processSyncQueue()`: Iniciar sincronización
- `addToQueue(action, entityType, entityId, data)`: Agregar manualmente
- `clearQueue()`: Limpiar cola
- `hasPendingSync()`: Verificar estado
- `checkQueueSize()`: Obtener cantidad
- Propiedades de estado:
  - `queueSize`: Items pendientes
  - `isSyncing`: En proceso
  - `syncProgress`: { current, total, percentage }
  - `lastSyncTime`: Última sincronización exitosa
  - `syncError`: Errores durante sync

#### Utilities

**distanceUtils.ts** (`src/utils/distanceUtils.ts`)
- `calculateDistance(loc1, loc2)`: Fórmula Haversine en km
- `formatDistance(distanceKm)`: "5.2 km" o "250 m"
- `calculateETA(distanceKm, speedKmh)`: Minutos de viaje
- `formatETA(minutes)`: "5 min" o "1h 30m"

**dateUtils.ts** (`src/utils/dateUtils.ts`)
- `getTodayDateString()`: YYYY-MM-DD
- `formatDateToString(date)`: Convertir a YYYY-MM-DD
- `getDayName(date)`: "Lunes", "Martes", etc.
- `formatDateForDisplay(date)`: "Lunes, 26 de enero"
- `isSameDay(date1, date2)`: Comparar ignorando hora
- `daysBetween(date1, date2)`: Diferencia en días
- `parseTime(timeString)`: "14:30" → { hours: 14, minutes: 30 }
- `formatTime(hours, minutes)`: 14, 30 → "14:30"

**constants/app.ts** (`src/constants/app.ts`)
- Timeouts: API (8s), Location (10s)
- Cache durations: Farmacias (7d), Turnos (1h), Ubicación (5m)
- Distancias: Search radius, opciones de filtro
- Notificaciones: Advance minutes, max per medication
- Validación: Min password, max field lengths
- URLs: MINSAL APIs
- Colores: Paleta primaria con semantic naming
- Enums: Status, frequencies, meal requirements, languages, themes

### Documentation

- CHANGELOG.md actualizado con índice de commits
- Archivos changelog por commit con detalles de cambios

## Arquitectura

### Offline-First Pattern

```
User Action
    ↓
Local State (Redux)
    ↓
AsyncStorage (Caché)
    ↓
Sync Queue (Si está offline)
    ↓
Firestore (Cuando online)
    ↓
Sync Completion Callback
```

### Retry Strategy

```
Action Failed
    ↓
Queue Item (retry_count = 0)
    ↓
Wait 1s
    ↓
Retry... Failed again (retry_count = 1)
    ↓
Wait 2s
    ↓
Retry... Failed again (retry_count = 2)
    ↓
Wait 4s
    ↓
Retry... Still Failed (retry_count = 3)
    ↓
Item Dropped (Max retries exceeded)
```

## Casos de Uso

### Crear Medicamento (Offline)

```typescript
// Componente
const { addToQueue } = useSyncQueue();
const medication = {
  id: 'med-123',
  medicationName: 'Paracetamol',
  // ...
};

// Guardar localmente
await medicationService.createMedication(userId, medication);

// Si offline, la creación ya está en AsyncStorage
// Sync queue se encarga automáticamente cuando online
```

### Registrar Adherencia (Offline)

```typescript
// Usuario toma medicamento offline
await medicationService.recordAdherence(userId, medicationId, true);

// Se guarda en AsyncStorage y se encola
// Cuando online, sync automático sube a Firestore
```

### Sincronizar Cambios Pendientes

```typescript
const { processSyncQueue, syncProgress, isSyncing } = useSyncQueue();

// Iniciar sync
await processSyncQueue();

// Mostrar progreso
if (isSyncing) {
  <Text>{syncProgress.percentage}% completado</Text>
}
```

## Testing

Servicios listos para unit tests:
- MockFirestore para tests
- AsyncStorage mock
- Notification mock

Ejemplos en fases posteriores.

## Próximos Pasos

- Phase 2: Implementar componentes que usen estos hooks
- Phase 3: Pharmacy locator UI con búsqueda/filtros
- Phase 4: Medication schedule UI con recordatorios
- Phase 5: Indicadores de sync offline/online
